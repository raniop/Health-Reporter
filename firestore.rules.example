rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ─── Users ───
    match /users/{userId} {
      // Any authenticated user can read profiles (search, leaderboard, view profile)
      allow read: if request.auth != null;
      // Only the owner can create/delete their own document
      allow create, delete: if request.auth != null && request.auth.uid == userId;
      // Update open to authenticated users (required for updating followersCount/followingCount)
      allow update: if request.auth != null;

      // Followers subcollection
      match /followers/{followerUid} {
        allow read: if request.auth != null;
        // The follower can add/remove themselves, or the owner can manage
        allow write: if request.auth != null &&
                     (request.auth.uid == userId || request.auth.uid == followerUid);
      }

      // Following subcollection
      match /following/{followingUid} {
        allow read: if request.auth != null;
        // The owner can manage who they follow, or the followed user can remove themselves (removeFollower)
        allow write: if request.auth != null &&
                     (request.auth.uid == userId || request.auth.uid == followingUid);
      }

      // Notifications subcollection (written by Cloud Functions or owner app, read/updated by owner)
      match /notifications/{notificationId} {
        allow read, create, update: if request.auth != null && request.auth.uid == userId;
      }

      // AION Memory subcollection (private to owner)
      match /aionMemory/{docId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // Legacy friends subcollection (backward compatibility)
      match /friends/{friendUid} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow write: if request.auth != null &&
                     (request.auth.uid == userId || request.auth.uid == friendUid);
      }
    }

    // ─── Follow Requests ───
    match /followRequests/{requestId} {
      // Any authenticated user can create a follow request
      allow create: if request.auth != null;

      // Read only my incoming/outgoing requests
      allow read: if request.auth != null &&
                  (request.auth.uid == resource.data.toUid ||
                   request.auth.uid == resource.data.fromUid);

      // Update only requests sent to me (approve/reject)
      allow update: if request.auth != null &&
                    request.auth.uid == resource.data.toUid;

      // Delete - the sender or recipient can delete
      allow delete: if request.auth != null &&
                    (request.auth.uid == resource.data.toUid ||
                     request.auth.uid == resource.data.fromUid);
    }

    // ─── Public Scores (leaderboard) ───
    match /publicScores/{userId} {
      // Any authenticated user can read public scores (leaderboard, profiles, search)
      allow read: if request.auth != null;
      // Only the owner can write their own score document
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // ─── Legacy Friend Requests (backward compatibility) ───
    match /friendRequests/{requestId} {
      allow create: if request.auth != null;
      allow read: if request.auth != null &&
                  (request.auth.uid == resource.data.toUid ||
                   request.auth.uid == resource.data.fromUid);
      allow update: if request.auth != null &&
                    request.auth.uid == resource.data.toUid;
      allow delete: if request.auth != null &&
                    (request.auth.uid == resource.data.toUid ||
                     request.auth.uid == resource.data.fromUid);
    }
  }
}
